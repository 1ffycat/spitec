name: Deploy Application

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      # Step to stop the running application
      - name: Stop Application
        run: |
          if [ -f "/tmp/gunicorn.pid" ]; then
            kill -9 $(cat /tmp/gunicorn.pid) || true
            rm /tmp/gunicorn.pid
          fi

      # Checkout the repository
      - name: Checkout Code
        uses: actions/checkout@v4

      # Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'  # Specify your Python version

      # Install Poetry
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -

      # Install dependencies
      - name: Install Dependencies
        run: |
          poetry install

      # Start the application
      - name: Start Application
        run: |
          RUNNER_TRACKING_ID=""
          if [ ! -d "./logging" ]; then
            mkdir logging
          fi
          nohup poetry run gunicorn -w 4 -b 0.0.0.0:8050 --pid /tmp/gunicorn.pid main:server > ./logging/log.txt 2>&1 &
          # Wait for PID file to confirm application start
          COUNTER=0
          while [ ! -f /tmp/gunicorn.pid ]; do
            if [ $COUNTER -ge 15 ]; then
              exit 1
            fi
            sleep 1
            COUNTER=$((COUNTER+1))
          done
          sleep 10

      # Archive logs as artifacts
      - name: Upload Logs
        uses: actions/upload-artifact@v4
        with:
          name: application-logs
          path: ./logging/log.txt
          retention-days: 7
